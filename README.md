# `database_doctor`

## About

### A database monitoring tool

`database_doctor` is a project created for CS 348 at the University of Waterloo. More details coming soon.

## Running locally

### For development

To run the `database_doctor` backend locally, first clone this repository:

```bash
git clone https://github.com/database-doctor/backend.git
```

Install all dependencies:

```bash
cd backend
npm install
```

(Optional) To spin up a local PostgreSQL database for testing, run:

```bash
docker-compose up
```

Then, create a `.env` file with the environment variables listed in `[root]/.env.example`. Setup the database with the Prisma ORM and GraphQL by running:

```bash
npx prisma db push
```

To spin up the project in development mode:

```bash
npm run dev
```

This will run two concurrent processes. 1) Will watch files in `src` for changes and compile them to `dist` with `tsc`. 2) Will use `nodemon` to keep the server live (run from `dist/index.js`).

### Using Prisma

The `prisma` tool can be called with `npx prisma [...]`. The most useful commands are:

- `npx prisma generate`
- `npx prisma studio`
- `npx prisma db push`
- `npx prisma migrate dev --name [changes_name]`

## SQL

Many of the sections below require downloading `psql`. To install `psql` with Homebrew on MacOS, run:

```bash
brew install libpq
brew link --force libpq
```

Assuming that the database was created/ran using the provided `docker-compose` configuration, then running the following command opens the CLI tool for the database:

```bash
psql -h localhost -dev -W -d postgres
```

Enter the password `password` when prompted. Also, use double quotation marks `"` for queries referring to any tables. Now, to run any SQL file against the database, you can run:

```bash
psql -h localhost -dev -W -d postgres < PATH/TO/FILE_NAME.sql
```

After entering the password, the SQL commands in `PATH/TO/FILE_NAME.sql` will be run against the database. To inspect changes, you can run

```
npx prisma studio
```

which opens a nice web interface to go through the database.

### Creating tables

We chose the Prisma DDL for this project, so the database schema is defined in [`prisma/schema.pisma`](prisma/schema.prisma), which, after preprocessing from Prisma, will generate a new migration under [`prisma/migrations/*/migration.sql`](prisma/migrations).

To add the schema to the database, running:

```bash
npx prisma db push
```

from the root folder will suffice.

### Sample data

The sample data was generated by using ChatGPT to create sample database schemas and database queries.

#### 1. Generating database schemas

The prompt used to generate database schemas was:

```
insert prompt here
```

#### 2. Generating queries

The prompt used to generate different queries towards the schemas generated in the previous step was:

```
insert prompt here
```

#### 3. Translating to SQL

Once this data was generated, it was translated to the SQL format manually, by writing `INSERT INTO` statements. See [sql/ddl/seed.sql](sql/ddl/seed.sql) for the full seeding SQL file.

#### 4. Populating the database with sample data

To populate the database with sample data, assuming you have `psql` already set up, run the following command from root, and enter `password` when prompted to enter the password:

```bash
psql -h localhost -dev -W -d postgres < sql/ddl/seed.sql
```

### Testing features

After performing all of the above steps (e.g. setting up the database and seeding it with the sample data), you can run the SQL feature queries from [sql/features/](sql/features/) by running:

```bash
psql -h localhost -dev -W -d postgres < sql/features/FEATURE_NAME/test.sql
```

We have written queries for R6 to R9 from our report.

## Application features

To run actual features against the application, you will need to run the application (see instructions for running locally). Then, you can visit `localhost:8080/graphql` from your browser, and make queries and mutations against the database. Currently, the following queries and mutations are supported:

1. Creating a User.
1. Querying a User by userId.
1. Querying all Users.

The GraphQL interface is self-documenting.

## Tech stack

- TypeScript
- Node.js
- Express
- GraphQL
- PrismaORM
- PostgreSQL
